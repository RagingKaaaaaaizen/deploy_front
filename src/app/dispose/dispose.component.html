

<!-- Add Disposal Modal -->
<div class="modal-overlay fixed top-20 left-72 right-4 bottom-4 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm" 
     *ngIf="showAddDisposalModal" 
     (click)="closeAddDisposalModal()">
  <div class="modal-container bg-white rounded-2xl shadow-2xl w-full h-full max-h-full overflow-hidden" (click)="$event.stopPropagation()">
    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-4">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-3">
        <div class="flex items-center">
          <div class="w-14 h-14 bg-white/20 text-white rounded-full flex items-center justify-center mr-3 text-xl">
            <i class="fas fa-trash-alt"></i>
          </div>
          <div>
            <h1 class="text-xl font-black text-white font-akira mb-1">{{ isEditMode ? 'Edit Disposal Record' : (disposalId ? 'View Disposal Record' : 'Dispose Items') }}</h1>
            <p class="text-white/80 font-inter text-sm">Manage inventory disposal records</p>
          </div>
        </div>
        <div class="flex gap-2">
          <a routerLink="/dispose" class="inline-flex items-center justify-center rounded-md px-3 py-2 font-semibold transition bg-white/20 hover:bg-white/30 text-white text-sm">
            <i class="fas fa-list mr-1"></i>
            View Disposals
          </a>
          <button class="inline-flex items-center justify-center rounded-full w-8 h-8 font-semibold transition bg-white/20 hover:bg-white/30 text-white" (click)="closeAddDisposalModal()">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="p-6 overflow-y-auto max-h-[calc(95vh-140px)] space-y-6">
      <!-- Available Stock Alert -->
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4 shadow-sm" *ngIf="availableStock > 0">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-info-circle text-sm"></i>
            </div>
            <div>
              <span class="text-blue-800 font-semibold text-sm block">Available Stock</span>
              <span class="text-blue-600 font-bold text-lg">{{ availableStock }} items</span>
            </div>
          </div>
          <button type="button" class="inline-flex items-center justify-center rounded-lg px-3 py-2 text-xs font-semibold transition bg-blue-500 text-white hover:bg-blue-600 shadow-sm" (click)="refreshStockData()" title="Refresh Stock Data">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
          </button>
        </div>
      </div>

      <!-- No Stock Available Alert -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4" *ngIf="availableStock === 0 && form.value.itemId">
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 text-sm"></i>
          <span class="text-yellow-800 font-semibold text-sm">No stock available for the selected item.</span>
        </div>
      </div>

      <!-- Error Alert -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6" *ngIf="error">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
          <span class="text-red-800 font-semibold">{{ error }}</span>
        </div>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-8">
        <!-- Item Selection -->
        <div class="space-y-3">
          <label class="block text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-box mr-2 text-indigo-600"></i> Item
          </label>
          <select formControlName="itemId" 
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none transition-all duration-200 font-inter"
                  [class.border-red-300]="submitted && f.itemId.errors"
                  [class.focus:border-red-500]="submitted && f.itemId.errors"
                  [class.focus:ring-red-100]="submitted && f.itemId.errors"
                  [disabled]="loading">
            <option value="">Select Item</option>
            <option *ngFor="let item of items" [value]="item.id">
              {{ item.name }}
            </option>
          </select>
          <div *ngIf="submitted && f.itemId.errors" class="text-red-600 text-sm">
            <div *ngIf="f.itemId.errors.required">Item is required</div>
          </div>
        </div>

        <!-- Quantity -->
        <div class="space-y-3">
          <label class="block text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-sort-numeric-up mr-2 text-indigo-600"></i> Quantity to Dispose
          </label>
          <input type="number" formControlName="quantity" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none transition-all duration-200 font-inter"
                 [class.border-red-300]="(submitted && f.quantity.errors) || f.quantity.errors?.insufficientStock"
                 [class.focus:border-red-500]="(submitted && f.quantity.errors) || f.quantity.errors?.insufficientStock"
                 [class.focus:ring-red-100]="(submitted && f.quantity.errors) || f.quantity.errors?.insufficientStock"
                 min="1"
                 [max]="availableStock"
                 [disabled]="loading">
          <div *ngIf="submitted && f.quantity.errors" class="text-red-600 text-sm">
            <div *ngIf="f.quantity.errors.required">Quantity is required</div>
            <div *ngIf="f.quantity.errors.min">Quantity must be at least 1</div>
            <div *ngIf="f.quantity.errors.insufficientStock">
              Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
            </div>
          </div>
          <div *ngIf="f.quantity.errors?.insufficientStock && !submitted" class="text-red-600 text-sm">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
          </div>
          <div class="text-gray-500 text-sm mt-2" *ngIf="availableStock > 0">
            <i class="fas fa-info-circle mr-1"></i> Maximum available: {{ availableStock }} items
          </div>
          <div class="text-yellow-600 text-sm mt-2" *ngIf="availableStock === 0 && form.value.itemId">
            <i class="fas fa-exclamation-circle mr-1"></i> No stock available for disposal
          </div>
        </div>

        <!-- Location -->
        <div class="space-y-3">
          <label class="block text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-map-marker-alt mr-2 text-indigo-600"></i> Storage Location
          </label>
          <select formControlName="locationId" 
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none transition-all duration-200 font-inter"
                  [class.border-red-300]="submitted && f.locationId.errors"
                  [class.focus:border-red-500]="submitted && f.locationId.errors"
                  [class.focus:ring-red-100]="submitted && f.locationId.errors"
                  [disabled]="loading">
            <option value="">Select Location</option>
            <option *ngFor="let location of locations" [value]="location.id">
              {{ location.name }}
            </option>
          </select>
          <div *ngIf="submitted && f.locationId.errors" class="text-red-600 text-sm">
            <div *ngIf="f.locationId.errors.required">Location is required</div>
          </div>
        </div>

        <!-- Disposal Value -->
        <div class="space-y-3">
          <label class="block text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-dollar-sign mr-2 text-indigo-600"></i> Disposal Value (total)
          </label>
          <input type="number" formControlName="disposalValue" 
                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none transition-all duration-200 font-inter"
                 [class.border-red-300]="submitted && f.disposalValue.errors"
                 [class.focus:border-red-500]="submitted && f.disposalValue.errors"
                 [class.focus:ring-red-100]="submitted && f.disposalValue.errors"
                 step="0.01" min="0.01"
                 [disabled]="loading">
          <div *ngIf="submitted && f.disposalValue.errors" class="text-red-600 text-sm">
            <div *ngIf="f.disposalValue.errors.required">Disposal value is required</div>
            <div *ngIf="f.disposalValue.errors.min">Disposal value must be greater than 0</div>
          </div>
          <div class="text-gray-500 text-sm mt-2">
            <i class="fas fa-info-circle mr-1"></i> Total value for all items being disposed (auto-calculated as price Ã— quantity)
            <div *ngIf="selectedItemPrice > 0" class="text-blue-600 mt-2 flex items-center">
              <i class="fas fa-lightbulb mr-1"></i> Latest item price: {{ selectedItemPrice | currency:'PHP':'symbol' }} per item
            </div>
          </div>
        </div>

        <!-- Reason -->
        <div class="space-y-3">
          <label class="block text-sm font-semibold text-gray-700 flex items-center">
            <i class="fas fa-comment mr-2 text-indigo-600"></i> Reason
          </label>
          <textarea formControlName="reason" 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none transition-all duration-200 font-inter resize-none"
                    rows="3"
                    placeholder="Reason for disposal, condition, etc."
                    [disabled]="loading"></textarea>
         </div>

        <!-- Buttons -->
        <div class="flex flex-wrap gap-4 pt-8 border-t border-gray-200">
          <button *ngIf="!disposalId || isEditMode" 
                  type="submit" 
                  class="btn-dispose inline-flex items-center justify-center px-6 py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" 
                  [disabled]="loading || form.invalid || f.quantity.errors?.insufficientStock">
            <div *ngIf="loading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            {{ isEditMode ? 'Update Disposal' : 'Dispose Items' }}
          </button>
          <button *ngIf="!disposalId && !isEditMode" 
                  type="button" 
                  class="btn-warning-custom inline-flex items-center justify-center px-6 py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" 
                  (click)="disposeAll()" 
                  [disabled]="loading || availableStock === 0 || !form.value.itemId">
            <div *ngIf="loading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            Dispose All Available
          </button>
          <button type="button" 
                  class="inline-flex items-center justify-center px-6 py-3 font-semibold transition border-2 border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 rounded-lg" 
                  (click)="closeAddDisposalModal()" 
                  [disabled]="loading">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div> 