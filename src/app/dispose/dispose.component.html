

<!-- Add Disposal Modal -->
<div class="modal-overlay" *ngIf="showAddDisposalModal" (click)="closeAddDisposalModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-title">
          <i class="fas fa-trash-alt"></i>
          <div>
            <h1 class="page-title">{{ isEditMode ? 'Edit Disposal Record' : (disposalId ? 'View Disposal Record' : 'Dispose Items') }}</h1>
            <p class="page-subtitle">Manage inventory disposal records</p>
          </div>
        </div>
        <div class="header-actions">
          <a routerLink="/dispose" class="btn btn-outline-secondary">
            <i class="fas fa-list"></i>
            View Disposals
          </a>
          <button class="btn btn-close" (click)="closeAddDisposalModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-body">
      <!-- Loading Skeleton -->
      <div *ngIf="loading" class="loading-skeleton">
          <!-- Form Content Skeleton - Facebook style -->
          <div class="form-content-skeleton">
              <app-skeleton type="text" width="100%" height="1.5rem" className="mb-3"></app-skeleton>
              <app-skeleton type="form" lines="4" className="mb-4"></app-skeleton>
              <div class="d-flex gap-2">
                  <app-skeleton type="button" width="120px" height="2.5rem"></app-skeleton>
                  <app-skeleton type="button" width="120px" height="2.5rem"></app-skeleton>
              </div>
          </div>
      </div>

      <!-- Actual Content -->
      <div *ngIf="!loading">
        <!-- Available Stock Alert -->
        <div class="alert alert-info" *ngIf="availableStock > 0">
          <strong>Available Stock:</strong> {{ availableStock }} items
          <button type="button" class="btn btn-sm btn-outline-info ms-2" (click)="refreshStockData()" title="Refresh Stock Data">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>

        <!-- No Stock Available Alert -->
        <div class="alert alert-warning" *ngIf="availableStock === 0 && form.value.itemId">
          <strong>No stock available</strong> for the selected item.
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger" *ngIf="error">
          {{ error }}
        </div>

        <!-- Form Content -->
        <div class="form-content">
            <div class="form-header">
                <h5><i class="fas fa-trash-alt text-danger me-2"></i> Dispose Stock Item</h5>
                <p class="text-muted">Remove items from inventory and track disposal information</p>
            </div>

            <form [formGroup]="form" (ngSubmit)="onSubmit()" #disposeForm="ngForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Item</label>
                        <select formControlName="itemId" class="form-select" 
                                [ngClass]="{ 'is-invalid': submitted && f.itemId.errors }"
                                [disabled]="loading">
                            <option value="">Select Item</option>
                            <option *ngFor="let item of items" [value]="item.id">
                                {{item.name}} - Available: {{getAvailableQuantity(item.id)}}
                            </option>
                        </select>
                        <div *ngIf="submitted && f.itemId.errors" class="invalid-feedback">
                            <div *ngIf="f.itemId.errors.required">Item is required</div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" formControlName="quantity" class="form-control" 
                               [ngClass]="{ 'is-invalid': (submitted && f.quantity.errors) || f.quantity.errors?.insufficientStock }"
                               min="1"
                               [max]="availableStock"
                               [disabled]="loading">
                        <div *ngIf="submitted && f.quantity.errors" class="invalid-feedback">
                            <div *ngIf="f.quantity.errors.required">Quantity is required</div>
                            <div *ngIf="f.quantity.errors.min">Quantity must be at least 1</div>
                            <div *ngIf="f.quantity.errors.insufficientStock">
                                Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
                            </div>
                        </div>
                        <div *ngIf="f.quantity.errors?.insufficientStock && !submitted" class="text-danger small">
                            <i class="fas fa-exclamation-triangle"></i>
                            Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
                        </div>
                        <small class="form-text text-muted" *ngIf="availableStock > 0">
                            Maximum available: {{ availableStock }} items
                        </small>
                        <small class="form-text text-warning" *ngIf="availableStock === 0 && form.value.itemId">
                            <i class="fas fa-exclamation-circle"></i> No stock available for disposal
                        </small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Disposal Value</label>
                        <input type="number" formControlName="disposalValue" class="form-control" 
                               [ngClass]="{ 'is-invalid': submitted && f.disposalValue.errors }"
                               step="0.01" min="0.01"
                               [disabled]="loading">
                        <div *ngIf="submitted && f.disposalValue.errors" class="invalid-feedback">
                            <div *ngIf="f.disposalValue.errors.required">Disposal value is required</div>
                            <div *ngIf="f.disposalValue.errors.min">Disposal value must be greater than 0</div>
                        </div>
                        <small class="form-text text-muted">
                            Total value for all items being disposed (auto-calculated as price Ã— quantity)
                            <span *ngIf="selectedItemPrice > 0" class="text-info">
                                <br>ðŸ’¡ Latest item price: {{ selectedItemPrice | currency:'PHP':'symbol' }} per item
                            </span>
                        </small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Reason</label>
                        <select formControlName="reason" class="form-select" 
                                [ngClass]="{ 'is-invalid': submitted && f.reason.errors }"
                                [disabled]="loading">
                            <option value="">Select Reason</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Obsolete">Obsolete</option>
                            <option value="Expired">Expired</option>
                            <option value="Lost">Lost</option>
                            <option value="Other">Other</option>
                        </select>
                        <div *ngIf="submitted && f.reason.errors" class="invalid-feedback">
                            <div *ngIf="f.reason.errors.required">Reason is required</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea formControlName="remarks" class="form-control" rows="3"
                                  placeholder="Reason for disposal, condition, etc."
                                  [disabled]="loading"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button *ngIf="!disposalId || isEditMode" type="submit" class="btn btn-danger" 
                            [disabled]="loading || form.invalid || f.quantity.errors?.insufficientStock">
                        <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
                        {{ isEditMode ? 'Update Disposal' : 'Dispose Items' }}
                    </button>
                    <button *ngIf="!disposalId && !isEditMode" type="button" class="btn btn-warning ms-2" 
                            (click)="disposeAll()" 
                            [disabled]="loading || availableStock === 0 || !form.value.itemId">
                        <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
                        Dispose All Available
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" (click)="closeAddDisposalModal()" [class.disabled]="loading">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
      </div>
    </div>
  </div>
</div> 