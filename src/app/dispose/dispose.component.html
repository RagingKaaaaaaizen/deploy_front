

<!-- Add Disposal Modal -->
<div class="modal-overlay" *ngIf="showAddDisposalModal" (click)="closeAddDisposalModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-title">
          <i class="fas fa-trash-alt"></i>
          <div>
            <h1 class="page-title">{{ isEditMode ? 'Edit Disposal Record' : (disposalId ? 'View Disposal Record' : 'Dispose Items') }}</h1>
            <p class="page-subtitle">Manage inventory disposal records</p>
          </div>
        </div>
        <div class="header-actions">
          <a routerLink="/dispose" class="btn btn-outline-secondary">
            <i class="fas fa-list"></i>
            View Disposals
          </a>
          <button class="btn btn-close" (click)="closeAddDisposalModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-body">
      <!-- Loading Skeleton -->
      <div *ngIf="loading" class="loading-skeleton">
          <!-- Form Content Skeleton - Facebook style -->
          <div class="form-content-skeleton">
              <app-skeleton type="text" width="100%" height="1.5rem" className="mb-3"></app-skeleton>
              <app-skeleton type="form" lines="4" className="mb-4"></app-skeleton>
              <div class="d-flex gap-2">
                  <app-skeleton type="button" width="120px" height="2.5rem"></app-skeleton>
                  <app-skeleton type="button" width="120px" height="2.5rem"></app-skeleton>
              </div>
          </div>
      </div>

      <!-- Actual Content -->
      <div *ngIf="!loading">
        <!-- Available Stock Alert -->
        <div class="alert alert-info" *ngIf="availableStock > 0">
          <strong>Available Stock:</strong> {{ availableStock }} items
          <button type="button" class="btn btn-sm btn-outline-info ms-2" (click)="refreshStockData()" title="Refresh Stock Data">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>

        <!-- No Stock Available Alert -->
        <div class="alert alert-warning" *ngIf="availableStock === 0 && form.value.itemId">
          <strong>No stock available</strong> for the selected item.
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger" *ngIf="error">
          {{ error }}
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()">
                   <!-- Item Selection -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-box"></i> Item
             </label>
             <select formControlName="itemId" class="form-control" 
                     [ngClass]="{ 'is-invalid': submitted && f.itemId.errors }"
                     [disabled]="loading">
               <option value="">Select Item</option>
               <option *ngFor="let item of items" [value]="item.id">
                 {{ item.name }}
               </option>
             </select>
             <div *ngIf="submitted && f.itemId.errors" class="invalid-feedback">
               <div *ngIf="f.itemId.errors.required">Item is required</div>
             </div>
           </div>

           <!-- Quantity -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-sort-numeric-up"></i> Quantity to Dispose
             </label>
             <input type="number" formControlName="quantity" class="form-control" 
                    [ngClass]="{ 'is-invalid': (submitted && f.quantity.errors) || f.quantity.errors?.insufficientStock }"
                    min="1"
                    [max]="availableStock"
                    [disabled]="loading">
             <div *ngIf="submitted && f.quantity.errors" class="invalid-feedback">
               <div *ngIf="f.quantity.errors.required">Quantity is required</div>
               <div *ngIf="f.quantity.errors.min">Quantity must be at least 1</div>
               <div *ngIf="f.quantity.errors.insufficientStock">
                 Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
               </div>
             </div>
             <div *ngIf="f.quantity.errors?.insufficientStock && !submitted" class="text-danger small">
               <i class="fas fa-exclamation-triangle"></i>
               Cannot dispose {{ f.quantity.value }} items. Only {{ f.quantity.errors.availableStock }} items available.
             </div>
             <small class="form-text text-muted" *ngIf="availableStock > 0">
               Maximum available: {{ availableStock }} items
             </small>
             <small class="form-text text-warning" *ngIf="availableStock === 0 && form.value.itemId">
               <i class="fas fa-exclamation-circle"></i> No stock available for disposal
             </small>
           </div>

           <!-- Location -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-map-marker-alt"></i> Storage Location
             </label>
             <select formControlName="locationId" class="form-control" 
                     [ngClass]="{ 'is-invalid': submitted && f.locationId.errors }"
                     [disabled]="loading">
               <option value="">Select Location</option>
               <option *ngFor="let location of locations" [value]="location.id">
                 {{ location.name }}
               </option>
             </select>
             <div *ngIf="submitted && f.locationId.errors" class="invalid-feedback">
               <div *ngIf="f.locationId.errors.required">Location is required</div>
             </div>
           </div>

           <!-- Disposal Value -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-dollar-sign"></i> Disposal Value (total)
             </label>
             <input type="number" formControlName="disposalValue" class="form-control" 
                    [ngClass]="{ 'is-invalid': submitted && f.disposalValue.errors }"
                    step="0.01" min="0.01"
                    [disabled]="loading">
             <div *ngIf="submitted && f.disposalValue.errors" class="invalid-feedback">
               <div *ngIf="f.disposalValue.errors.required">Disposal value is required</div>
               <div *ngIf="f.disposalValue.errors.min">Disposal value must be greater than 0</div>
             </div>
             <small class="form-text text-muted">
               Total value for all items being disposed (auto-calculated as price Ã— quantity)
               <span *ngIf="selectedItemPrice > 0" class="text-info">
                 <br>ðŸ’¡ Latest item price: {{ selectedItemPrice | currency:'PHP':'symbol' }} per item
               </span>
             </small>
           </div>

           <!-- Reason -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-comment"></i> Reason
             </label>
             <textarea formControlName="reason" class="form-control" rows="3"
                       placeholder="Reason for disposal, condition, etc."
                       [disabled]="loading"></textarea>
           </div>

          <!-- Buttons -->
          <div class="mb-3">
            <button *ngIf="!disposalId || isEditMode" type="submit" class="btn btn-danger" 
                    [disabled]="loading || form.invalid || f.quantity.errors?.insufficientStock">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              {{ isEditMode ? 'Update Disposal' : 'Dispose Items' }}
            </button>
            <button *ngIf="!disposalId && !isEditMode" type="button" class="btn btn-warning ms-2" 
                    (click)="disposeAll()" 
                    [disabled]="loading || availableStock === 0 || !form.value.itemId">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              Dispose All Available
            </button>
            <button type="button" class="btn btn-secondary ms-2" (click)="closeAddDisposalModal()" [class.disabled]="loading">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 