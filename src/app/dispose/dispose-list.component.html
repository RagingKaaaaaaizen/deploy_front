<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-4">
  <div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-trash-alt text-white text-lg"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900 font-akira">Disposal Records</h1>
            <p class="text-gray-600 font-inter text-sm">Track and manage inventory disposal activities</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" (click)="addNewDisposal()">
            <i class="fas fa-plus"></i>
            Add Disposal
          </button>
          <button class="btn btn-info" (click)="refreshStockData()" title="Refresh Stock Data">
            <i class="fas fa-sync-alt"></i>
            Refresh Stock
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 text-center hover:shadow-xl transition-shadow duration-300">
        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-trash-alt text-white text-lg"></i>
        </div>
        <div class="text-xl font-bold text-gray-900 font-akira">{{ disposals.length }}</div>
        <div class="text-xs text-gray-600 font-inter">Total Disposals</div>
      </div>
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 text-center hover:shadow-xl transition-shadow duration-300">
        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-boxes text-white text-lg"></i>
        </div>
        <div class="text-xl font-bold text-gray-900 font-akira">{{ getTotalDisposedItems() }}</div>
        <div class="text-xs text-gray-600 font-inter">Items Disposed</div>
      </div>
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 text-center hover:shadow-xl transition-shadow duration-300">
        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-dollar-sign text-white text-lg"></i>
        </div>
        <div class="text-xl font-bold text-gray-900 font-akira">{{ getTotalDisposalValue() | currency:'PHP':'symbol':'1.0-0' }}</div>
        <div class="text-xs text-gray-600 font-inter">Total Value</div>
      </div>
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 text-center hover:shadow-xl transition-shadow duration-300">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-calendar-alt text-white text-lg"></i>
        </div>
        <div class="text-xl font-bold text-gray-900 font-akira">{{ getThisMonthDisposals() }}</div>
        <div class="text-xs text-gray-600 font-inter">This Month</div>
      </div>
    </div>

    <!-- Filters and Search -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
          <input 
            type="text" 
            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 font-inter" 
            placeholder="Search disposals..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
          >
        </div>
        <div>
          <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 font-inter" [(ngModel)]="selectedCategory" (change)="onFilterChange()">
            <option value="">All Categories</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
        <div>
          <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 font-inter" [(ngModel)]="selectedLocation" (change)="onFilterChange()">
            <option value="">All Locations</option>
            <option *ngFor="let location of locations" [value]="location.id">
              {{ location.name }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Disposal Records Table -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h5 class="text-lg font-semibold text-gray-900 flex items-center gap-2 font-montserrat">
            <i class="fas fa-list text-blue-600"></i> Disposal Records
          </h5>
          <div class="flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="refreshData()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
        </div>
      </div>
      <div class="p-0">
        <!-- Loading -->
        <div *ngIf="loading" class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-gray-600">Loading disposal records...</p>
        </div>

        <!-- Table -->
        <div *ngIf="!loading" class="overflow-hidden">
          <table class="w-full border-collapse table-auto">
            <thead>
              <tr class="bg-gray-50">
                <th class="font-montserrat text-left">
                  <i class="fas fa-box mr-1"></i> Item Name
                </th>
                <th class="font-montserrat text-center">
                  <i class="fas fa-tag mr-1"></i> Category
                </th>
                <th class="font-montserrat text-center">
                  <i class="fas fa-trademark mr-1"></i> Brand
                </th>
                <th class="font-montserrat text-center">
                  <i class="fas fa-sort-numeric-up mr-1"></i> Quantity
                </th>
                <th class="font-montserrat text-center">
                  <i class="fas fa-calendar mr-1"></i> Disposal Date
                </th>
                <th class="font-montserrat text-center">
                  <i class="fas fa-cogs mr-1"></i> Actions
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let disposal of paginatedDisposals" class="hover:bg-gray-50 transition-colors duration-200">
                <!-- Item Name -->
                <td class="font-inter align-middle" data-label="Item">
                  <strong class="font-montserrat text-sm">{{ disposal.item?.name || 'Unknown Item' }}</strong>
                </td>
                
                <!-- Category -->
                <td class="font-inter text-center align-middle" data-label="Category">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {{ disposal.item?.category?.name || 'No Category' }}
                  </span>
                </td>
                
                <!-- Brand -->
                <td class="font-inter text-center align-middle" data-label="Brand">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                    {{ disposal.item?.brand?.name || 'No Brand' }}
                  </span>
                </td>
                
                <!-- Quantity -->
                <td class="font-inter text-center align-middle" data-label="Quantity">
                  <div class="flex flex-col items-center gap-1">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                      {{ disposal.quantity }}
                    </span>
                    <span *ngIf="disposal.returnedToStock" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <i class="fas fa-check mr-1"></i> Returned
                    </span>
                    <span *ngIf="disposal.quantity < disposal.originalQuantity" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      <i class="fas fa-undo mr-1"></i> Partial
                    </span>
                  </div>
                </td>
                
                <!-- Disposal Date -->
                <td class="font-inter text-center align-middle" data-label="Date">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <i class="fas fa-calendar mr-1"></i>
                    {{ disposal.disposalDate | date: 'MMM dd, yyyy' }}
                  </span>
                </td>
                
                <!-- Actions -->
                <td class="font-inter text-center align-middle" data-label="Actions">
                  <div class="flex flex-row gap-1 justify-center">
                    <button class="inline-flex items-center justify-center w-8 h-8 rounded-md transition bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200"
                            (click)="viewDisposal(disposal.id!)" title="View Full Details">
                      <i class="fas fa-eye text-sm"></i>
                    </button>
                    <button *ngIf="hasRole([Role.SuperAdmin, Role.Admin])" 
                            class="inline-flex items-center justify-center w-8 h-8 rounded-md transition bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200"
                            (click)="editDisposal(disposal.id!)" title="Edit Disposal">
                      <i class="fas fa-edit text-sm"></i>
                    </button>
                    <button *ngIf="hasRole([Role.SuperAdmin, Role.Admin])" 
                            class="inline-flex items-center justify-center w-8 h-8 rounded-md transition bg-red-50 text-red-700 hover:bg-red-100 border border-red-200"
                            (click)="deleteDisposal(disposal.id!)" title="Delete Disposal">
                      <i class="fas fa-trash text-sm"></i>
                    </button>
                    <button class="inline-flex items-center justify-center w-8 h-8 rounded-md transition bg-teal-50 text-teal-700 hover:bg-teal-100 border border-teal-200"
                            (click)="viewStockInfo(disposal.itemId)" title="View Stock Info">
                      <i class="fas fa-boxes text-sm"></i>
                    </button>
                    <button *ngIf="disposal.quantity > 0" 
                            class="inline-flex items-center justify-center w-8 h-8 rounded-md transition bg-green-50 text-green-700 hover:bg-green-100 border border-green-200"
                            (click)="returnToStock(disposal)" title="Return to Stock">
                      <i class="fas fa-undo text-sm"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredDisposals?.length === 0">
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                  <div class="empty-state">
                    <i class="fas fa-trash-alt text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold mb-2 font-montserrat">No disposal records found</h4>
                    <p class="text-sm font-inter">Try adjusting your search or filters</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-section" *ngIf="filteredDisposals?.length > 0">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ Math.min(currentPage * itemsPerPage, filteredDisposals.length) }} of {{ filteredDisposals.length }} entries
      </div>
      <nav aria-label="Disposal pagination">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="previousPage()">
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>
          <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="nextPage()">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Add Disposal Modal -->
  <div class="modal-overlay" *ngIf="showAddDisposalModal" (click)="closeAddDisposalModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-title">
            <i class="fas fa-trash-alt"></i>
            <div>
              <h1 class="page-title">Dispose Items</h1>
              <p class="page-subtitle">Manage inventory disposal records</p>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-close" (click)="closeAddDisposalModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-body">
                                   <!-- Available Stock Alert -->
          <div class="alert alert-info" *ngIf="availableStock > 0">
            <strong>Available Stock:</strong> {{ availableStock }} units
            <button type="button" class="btn btn-sm btn-outline-info ms-2" (click)="refreshStockData()" title="Refresh Stock Data">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>

          <!-- Debug Info -->
          <div class="alert alert-secondary">
            <strong>Debug Info:</strong><br>
            Available Stock Entries: {{ availableStockEntries.length }}<br>
            Selected Stock Entry ID: {{ form.value.stockEntryId || 'None' }}<br>
            Available Stock: {{ availableStock }}<br>
            Selected Item Price: {{ selectedItemPrice }}<br>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" (click)="debugStockData()" title="Debug Stock Data">
              <i class="fas fa-bug"></i> Debug Data
            </button>
          </div>

                                       <!-- No Stock Available Alert -->
          <div class="alert alert-warning" *ngIf="availableStock === 0 && form.value.stockEntryId">
            <strong>No stock available</strong> for the selected stock entry.
          </div>

          <!-- Selected Stock Summary -->
          <div class="alert alert-info" *ngIf="form.value.stockEntryId && availableStock > 0">
            <div class="row">
              <div class="col-md-6">
                <strong>Selected Stock Entry:</strong><br>
                <span *ngIf="getSelectedStock()">
                  <strong>Item:</strong> {{ getSelectedStock()?.item?.name }}<br>
                  <strong>Category:</strong> {{ getSelectedStock()?.item?.category?.name }}<br>
                  <strong>Brand:</strong> {{ getSelectedStock()?.item?.brand?.name }}<br>
                  <strong>Available:</strong> {{ availableStock }} units<br>
                  <strong>Price:</strong> ₱{{ selectedItemPrice | number:'1.2-2' }} per unit
                </span>
              </div>
              <div class="col-md-6">
                <strong>Disposal Summary:</strong><br>
                <strong>Quantity to Dispose:</strong> {{ form.value.quantity || 0 }} units<br>
                <strong>Total Value:</strong> ₱{{ getTotalValue() | number:'1.2-2' }}<br>
                <strong>Location:</strong> {{ getSelectedStockLocation() }}
              </div>
            </div>
          </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()">
                     <!-- Stock Selection -->
           <div class="mb-3">
                           <label class="form-label">
                <i class="fas fa-boxes"></i> Select Stock Entry
              </label>
                                         <select formControlName="stockEntryId" class="form-control" 
                      [ngClass]="{ 'is-invalid': submitted && f.stockEntryId.errors }"
                      [disabled]="loading">
                <option value="">Select Stock Entry</option>
                <option *ngFor="let stock of availableStockEntries" [value]="stock.id">
                  {{ stock.item?.name || 'Unknown Item' }} ({{ stock.item?.category?.name }}) - {{ stock.quantity }} units - ₱{{ stock.price | number:'1.2-2' }} each - {{ stock.location?.name }} - {{ stock.createdAt | date:'MMM dd, yyyy HH:mm' }}
                </option>
              </select>
              <div *ngIf="submitted && f.stockEntryId.errors" class="invalid-feedback">
                <div *ngIf="f.stockEntryId.errors.required">Stock entry is required</div>
              </div>
              <small class="form-text text-muted">
                Shows: Item Name (Category) - Available Quantity - Price per unit - Location - Date Added
              </small>
           </div>

                     <!-- Quantity -->
           <div class="mb-3">
             <label class="form-label">
               <i class="fas fa-sort-numeric-up"></i> Quantity to Dispose
             </label>
                                         <input type="number" formControlName="quantity" class="form-control" 
                      [ngClass]="{ 'is-invalid': submitted && f.quantity.errors }"
                      min="1"
                      [max]="availableStock"
                      [disabled]="loading || !form.value.stockEntryId"
                      placeholder="Enter quantity to dispose">
             <div *ngIf="submitted && f.quantity.errors" class="invalid-feedback">
               <div *ngIf="f.quantity.errors.required">Quantity is required</div>
               <div *ngIf="f.quantity.errors.min">Quantity must be at least 1</div>
               <div *ngIf="f.quantity.errors.maxQuantity">Quantity cannot exceed available stock ({{ f.quantity.errors.maxQuantity.max }} units)</div>
             </div>
             <small class="form-text text-muted" *ngIf="availableStock > 0">
               <i class="fas fa-info-circle"></i> Maximum available: {{ availableStock }} units | 
               <strong>Total Value:</strong> ₱{{ getTotalValue() | number:'1.2-2' }}
             </small>
                           <small class="form-text text-warning" *ngIf="availableStock === 0 && form.value.stockEntryId">
                <i class="fas fa-exclamation-circle"></i> No stock available for disposal
              </small>
           </div>

          <!-- Location (Auto-populated) -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-map-marker-alt"></i> Storage Location
            </label>
            <input type="text" class="form-control" 
                   [value]="getSelectedStockLocation()" 
                   readonly 
                   style="background-color: #f8f9fa;">
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> Location is automatically set from the selected stock entry
            </small>
          </div>



          <!-- Reason -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-comment"></i> Reason
            </label>
                         <textarea formControlName="reason" class="form-control" rows="3"
                       placeholder="Reason for disposal, condition, etc."
                       [disabled]="loading"></textarea>
          </div>

          <!-- Buttons -->
          <div class="mb-3">
                         <button type="submit" class="btn btn-danger" 
                     [disabled]="loading || form.invalid">
               <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
               Dispose Units
             </button>
                         <button type="button" class="btn btn-warning ms-2" 
                     (click)="disposeAll()" 
                     [disabled]="loading || availableStock === 0 || !form.value.stockEntryId">
               <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
               Dispose All Available Units
             </button>
            <button type="button" class="btn btn-secondary ms-2" (click)="closeAddDisposalModal()" [class.disabled]="loading">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Return to Stock Modal -->
  <div class="modal-overlay" *ngIf="showReturnToStockModal" (click)="closeReturnToStockModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-title">
            <i class="fas fa-undo"></i>
            <div>
              <h1 class="page-title">Return to Stock</h1>
              <p class="page-subtitle">Return disposed items back to inventory</p>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-close" (click)="closeReturnToStockModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <!-- Item Information -->
        <div class="alert alert-info">
          <div class="row">
            <div class="col-md-6">
              <strong>Item:</strong> {{ selectedDisposal?.item?.name || 'Unknown Item' }}<br>
              <strong>Category:</strong> {{ selectedDisposal?.item?.category?.name || 'No Category' }}<br>
              <strong>Brand:</strong> {{ selectedDisposal?.item?.brand?.name || 'No Brand' }}
            </div>
            <div class="col-md-6">
              <strong>Current Disposed:</strong> {{ selectedDisposal?.quantity || 0 }} units<br>
              <strong>Disposal Value:</strong> {{ getDisposalValue() | currency:'PHP':'symbol' }}<br>
              <strong>Location:</strong> {{ selectedDisposal?.location?.name || 'No Location' }}
            </div>
          </div>
        </div>

        <form [formGroup]="returnForm" (ngSubmit)="onReturnSubmit()">
          <!-- Quantity to Return -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-sort-numeric-up"></i> Quantity to Return
            </label>
            <input type="number" formControlName="quantity" class="form-control" 
                   [ngClass]="{ 'is-invalid': returnSubmitted && returnForm.get('quantity')?.errors }"
                   min="1"
                   [max]="selectedDisposal?.quantity || 1"
                   placeholder="Enter quantity to return to stock">
            <div *ngIf="returnSubmitted && returnForm.get('quantity')?.errors" class="invalid-feedback">
              <div *ngIf="returnForm.get('quantity')?.errors?.['required']">Quantity is required</div>
              <div *ngIf="returnForm.get('quantity')?.errors?.['min']">Quantity must be at least 1</div>
              <div *ngIf="returnForm.get('quantity')?.errors?.['max']">Quantity cannot exceed disposed amount</div>
            </div>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> Maximum: {{ selectedDisposal?.quantity || 0 }} units | 
              <strong>Total Value:</strong> ₱{{ getReturnTotalValue() | number:'1.2-2' }}
            </small>
          </div>

          <!-- Remarks -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-comment"></i> Remarks
            </label>
            <textarea formControlName="remarks" class="form-control" rows="3"
                      placeholder="Reason for returning to stock, condition, etc."></textarea>
            <small class="form-text text-muted">
              <i class="fas fa-info-circle"></i> Optional: Add notes about the return
            </small>
          </div>

          <!-- Buttons -->
          <div class="mb-3">
            <button type="submit" class="btn btn-success" 
                    [disabled]="loading || returnForm.invalid">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              Return to Stock
            </button>
            <button type="button" class="btn btn-warning ms-2" 
                    (click)="returnAll()" 
                    [disabled]="loading || !selectedDisposal?.quantity">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              Return All Units
            </button>
            <button type="button" class="btn btn-secondary ms-2" (click)="closeReturnToStockModal()" [class.disabled]="loading">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 