<div class="list-container">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-desktop"></i>
                    <div>
                        <h1 class="page-title">PC Management</h1>
                        <p class="page-subtitle">Manage and track your computer systems</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-info me-2" routerLink="/pc/templates">
                        <i class="fas fa-clipboard-list"></i>
                        Manage Templates
                    </button>
                    <button type="button" class="btn btn-primary" (click)="openAddPCModal()" *ngIf="hasRole([Role.SuperAdmin, Role.Admin, Role.Staff])">
                        <i class="fas fa-plus"></i>
                        Add PC
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <div class="stat-number">{{ pcs.length }}</div>
                <div class="stat-label">Total PCs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number">{{ getActiveCount() }}</div>
                <div class="stat-label">Active PCs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <div class="stat-number">{{ getMaintenanceCount() }}</div>
                <div class="stat-label">In Maintenance</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="stat-number">{{ getAutoUpdatedCount() }}</div>
                <div class="stat-label">Auto-Updated</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="stat-number">{{ getUniqueLocations() }}</div>
                <div class="stat-label">Locations</div>
            </div>
        </div>

        <!-- PC Export Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-download text-primary me-2"></i> Export PC Reports</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-file-excel text-success me-2"></i>PC List Export (Excel)
                        </h6>
                        <button 
                            class="btn btn-success btn-sm me-2" 
                            (click)="downloadPCList()">
                            <i class="fas fa-file-excel me-1"></i>
                            Download PC List
                        </button>
                        <small class="text-muted d-block mt-1">
                            Exports complete PC inventory with component details and status
                        </small>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-file-word text-primary me-2"></i>PC Analysis Reports (Word)
                        </h6>
                        <div class="btn-group-vertical d-block">
                            <button 
                                class="btn btn-outline-primary btn-sm mb-1" 
                                (click)="downloadWeeklyPCAnalysis()">
                                <i class="fas fa-file-word me-1"></i>
                                Weekly Analysis
                            </button>
                            <button 
                                class="btn btn-outline-primary btn-sm mb-1" 
                                (click)="downloadMonthlyPCAnalysis()">
                                <i class="fas fa-file-word me-1"></i>
                                Monthly Analysis
                            </button>
                            <button 
                                class="btn btn-outline-primary btn-sm" 
                                (click)="downloadYearlyPCAnalysis()">
                                <i class="fas fa-file-word me-1"></i>
                                Yearly Analysis
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            Exports detailed PC analysis with maintenance information in Word format
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="filters-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="Search PCs..."
                            [(ngModel)]="searchTerm"
                            (input)="onSearch()"
                        >
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-controls">
                        <select class="form-select" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Retired">Retired</option>
                        </select>
                        <select class="form-select" [(ngModel)]="selectedLocation" (change)="onFilterChange()">
                            <option value="">All Locations</option>
                            <option *ngFor="let location of locations" [value]="location.id">
                                {{ location.name }}
                            </option>
                        </select>
                        <select class="form-select" [(ngModel)]="selectedTemplateId" (change)="onTemplateFilterChange()">
                            <option [ngValue]="null">
                                <i class="fas fa-clipboard-list"></i> Compare with Template
                            </option>
                            <option *ngFor="let template of templates" [ngValue]="template.id">
                                ðŸ“‹ {{ template.name }}
                            </option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" (click)="clearAllFilters()">
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
            <!-- Active filter chips -->
            <div class="mt-3" *ngIf="searchTerm || selectedStatus || selectedLocation || selectedTemplateId">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <small class="text-muted me-2">Filters:</small>
                    <span class="badge bg-light text-dark border" *ngIf="searchTerm">
                        Search: "{{ searchTerm }}"
                        <button class="btn btn-sm btn-link text-decoration-none" (click)="clearSearch()" aria-label="Clear search">âœ•</button>
                    </span>
                    <span class="badge bg-light text-dark border" *ngIf="selectedStatus">
                        Status: {{ selectedStatus }}
                        <button class="btn btn-sm btn-link text-decoration-none" (click)="clearStatusFilter()" aria-label="Clear status filter">âœ•</button>
                    </span>
                    <span class="badge bg-light text-dark border" *ngIf="selectedLocation">
                        Location: {{ getSelectedLocationName() }}
                        <button class="btn btn-sm btn-link text-decoration-none" (click)="clearLocationFilter()" aria-label="Clear location filter">âœ•</button>
                    </span>
                    <span class="badge bg-light text-dark border" *ngIf="selectedTemplateId">
                        Template: {{ getTemplateNameById(selectedTemplateId) || 'Selected' }}
                        <button class="btn btn-sm btn-link text-decoration-none" (click)="clearTemplateFilter()" aria-label="Clear template filter">âœ•</button>
                    </span>
                </div>
            </div>
        </div>

        <!-- PC Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> PC Systems</h5>
                <div class="table-actions">
                    <button class="btn btn-sm btn-outline-secondary" (click)="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading state -->
                <div class="d-flex justify-content-center my-4" *ngIf="loadingPCs">
                    <div class="spinner-border text-primary" role="status" aria-live="polite" aria-label="Loading PCs">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th><i class="fas fa-desktop"></i> PC Name</th>
                                <th><i class="fas fa-map-marker-alt"></i> Location</th>
                                <th><i class="fas fa-info-circle"></i> Status</th>
                                <th><i class="fas fa-microchip"></i> Component Status</th>
                                <th><i class="fas fa-calendar"></i> Created</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                                                         <tr *ngFor="let pc of paginatedPCs" class="pc-row">
                                 <td data-label="PC Name">
                                     <div class="pc-info">
                                         <strong>{{ pc.name }}</strong>
                                         <small class="d-block text-muted" *ngIf="pc.notes">
                                             {{ pc.notes }}
                                         </small>
                                     </div>
                                 </td>
                                 <td data-label="Location">
                                     <span class="location-badge">
                                         {{ getLocationName(pc.roomLocationId) }}
                                     </span>
                                 </td>
                                 <td data-label="Status">
                                     <span class="status-badge" [ngClass]="{
                                         'badge-success': pc.status === 'Active',
                                         'badge-warning': pc.status === 'Maintenance',
                                         'badge-secondary': pc.status === 'Inactive',
                                         'badge-danger': pc.status === 'Retired'
                                     }">
                                         <i class="fas fa-circle"></i> {{ pc.status }}
                                     </span>
                                     <small class="d-block text-muted mt-1" *ngIf="getComponentStatus(pc.id).status !== 'No Components'">
                                         <i class="fas fa-sync-alt"></i> Auto-updated based on components
                                     </small>
                                 </td>
                                 <td data-label="Component Status">
                                     <span class="status-badge" [ngClass]="{
                                         'badge-success': getComponentStatus(pc.id).status === 'Working',
                                         'badge-warning': getComponentStatus(pc.id).status === 'Maintenance',
                                         'badge-danger': getComponentStatus(pc.id).status === 'Not Working',
                                         'badge-secondary': getComponentStatus(pc.id).status === 'No Components'
                                     }">
                                         <i class="fas fa-microchip"></i> {{ getComponentStatus(pc.id).status }}
                                     </span>
                                     <small class="d-block text-muted" *ngIf="getComponentStatus(pc.id).componentCount > 0">
                                         {{ getComponentStatus(pc.id).componentCount }} component(s)
                                     </small>
                                     <!-- Template Comparison Badge -->
                                     <div *ngIf="selectedTemplateId && getPCComparison(pc.id)" class="mt-2">
                                         <span class="match-badge" [ngClass]="{
                                           'perfect-match': getPCComparison(pc.id)?.matches,
                                           'partial-match': !getPCComparison(pc.id)?.matches && getPCComparison(pc.id)?.matchPercentage >= 70,
                                           'poor-match': !getPCComparison(pc.id)?.matches && getPCComparison(pc.id)?.matchPercentage < 70
                                         }">
                                             <i class="fas" [ngClass]="getComparisonIcon(pc.id)"></i>
                                             {{ getPCComparison(pc.id)?.matches ? 'Perfect Match' : getPCComparison(pc.id)?.matchPercentage + '% Match' }}
                                         </span>
                                         <small class="d-block text-muted mt-1" *ngIf="!getPCComparison(pc.id)?.matches">
                                             <i class="fas fa-exclamation-circle me-1"></i>
                                             {{ getPCComparison(pc.id)?.mismatchCount }} component(s) need attention
                                         </small>
                                     </div>
                                     <div *ngIf="selectedTemplateId && loadingComparisons" class="mt-2">
                                         <span class="template-loading">
                                             <span class="template-spinner"></span>
                                             Comparing...
                                         </span>
                                     </div>
                                 </td>
                                 <td data-label="Created">
                                     <span class="created-date">
                                         {{ pc.createdAt | date:'short' }}
                                     </span>
                                 </td>
                                 <td data-label="Actions">
                                     <div class="action-buttons">
                                        <button type="button" class="btn btn-sm btn-outline-primary" aria-label="View PC details"
                                                (click)="viewPC(pc.id)" title="View Details">
                                             <i class="fas fa-eye"></i>
                                         </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" aria-label="View PC components"
                                                (click)="viewComponents(pc.id)" title="View Components">
                                             <i class="fas fa-microchip"></i>
                                         </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" aria-label="Edit PC"
                                                (click)="editPC(pc.id)" title="Edit PC"
                                                 *ngIf="hasRole([Role.SuperAdmin, Role.Admin, Role.Staff])">
                                             <i class="fas fa-edit"></i>
                                         </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Delete PC"
                                                (click)="deletePC(pc.id)" title="Delete PC"
                                                 *ngIf="hasRole([Role.SuperAdmin, Role.Admin, Role.Staff])">
                                             <i class="fas fa-trash"></i>
                                         </button>
                                     </div>
                                 </td>
                             </tr>
                            <tr *ngIf="paginatedPCs.length === 0">
                                <td colspan="6" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="fas fa-desktop"></i>
                                        <h4>No PCs found</h4>
                                        <p>Try adjusting your search or filters</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-section" *ngIf="filteredPCs.length > 0">
            <div class="pagination-info">
                Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ Math.min(currentPage * itemsPerPage, filteredPCs.length) }} of {{ filteredPCs.length }} entries
            </div>
            <nav aria-label="PC pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item" [class.disabled]="currentPage === 1">
                        <a class="page-link" (click)="previousPage()">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
                        <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" [class.disabled]="currentPage === totalPages">
                        <a class="page-link" (click)="nextPage()">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Add PC Modal -->
<div class="modal fade show" *ngIf="showAddPCModal" tabindex="-1" style="display: block; background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-desktop me-2"></i>Add New PC
                </h5>
                <button type="button" class="btn-close" (click)="closeAddPCModal()"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="pcForm" (ngSubmit)="onSubmitPC()">
                    <!-- PC Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>PC Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">PC Name *</label>
                                        <input type="text" class="form-control" formControlName="name" 
                                               placeholder="Enter PC name">
                                        <div *ngIf="submitted && pcForm.get('name')?.errors?.['required']" 
                                             class="text-danger small">PC Name is required</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label">Room Location *</label>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    (click)="loadRoomLocations()" title="Refresh room locations">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <select class="form-select" formControlName="roomLocationId">
                                            <option value="">Select Room Location</option>
                                            <option *ngFor="let location of roomLocations" [value]="location.id">
                                                {{ location.name }}
                                            </option>
                                        </select>
                                        <div *ngIf="submitted && pcForm.get('roomLocationId')?.errors?.['required']" 
                                             class="text-danger small">Room Location is required</div>
                                        <small class="form-text text-muted" *ngIf="roomLocations.length === 0">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                            No room locations available. Click refresh or contact administrator.
                                        </small>
                                        <small class="form-text text-info" *ngIf="roomLocations.length > 0">
                                            <i class="fas fa-info-circle"></i>
                                            {{ roomLocations.length }} room location(s) available
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" formControlName="status">
                                            <option value="Active">ðŸŸ¢ Active</option>
                                            <option value="Inactive">âšª Inactive</option>
                                            <option value="Maintenance">ðŸŸ¡ Maintenance</option>
                                            <option value="Retired">ðŸ”´ Retired</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" formControlName="notes" rows="2" 
                                                  placeholder="Optional notes about this PC"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Information (Remove in production) -->
                    <div class="card mb-4 border-warning" *ngIf="roomLocations.length > 0">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-bug me-2"></i>Debug: Room Locations Data
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let location of roomLocations">
                                            <td>{{ location.id }}</td>
                                            <td>{{ location.name }}</td>
                                            <td>{{ location.description || 'No description' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <small class="text-muted">
                                <strong>Selected Value:</strong> {{ pcForm.value.roomLocationId || 'None selected' }}
                            </small>
                        </div>
                    </div>

                    <!-- Default Components Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-microchip me-2"></i>Default Components Configuration
                            </h6>
                            <small class="text-muted">Set the default components for this PC. Components matching these defaults will be marked as "Component Match".</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Category Selection -->
                                <div class="col-md-12 mb-4">
                                    <label class="form-label">Select Categories for Default Components</label>
                                    <div class="row">
                                        <div class="col-md-3" *ngFor="let category of categories">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       [value]="category.id" 
                                                       (change)="onCategorySelect(category, $event)"
                                                       [id]="'category_' + category.id">
                                                <label class="form-check-label" [for]="'category_' + category.id">
                                                    {{ category.name }}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Categories with Items -->
                            <div *ngFor="let selectedCategory of selectedCategories" class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-tag me-2"></i>{{ selectedCategory.name }} - Default Component
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Select Default {{ selectedCategory.name }} *</label>
                                        <select class="form-select" 
                                                [(ngModel)]="defaultComponents[selectedCategory.id]"
                                                [ngModelOptions]="{standalone: true}">
                                            <option value="">Select {{ selectedCategory.name }}</option>
                                            <option *ngFor="let item of getItemsByCategory(selectedCategory.id)" 
                                                    [value]="item.id">
                                                {{ item.name }}
                                                <span *ngIf="item.brand"> - {{ item.brand.name }}</span>
                                            </option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Components matching this default will be marked as "Component Match" when added to the PC.
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div *ngIf="selectedCategories.length === 0" class="text-center text-muted p-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p>Select categories above to configure default components for this PC.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeAddPCModal()">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" (click)="onSubmitPC()" [disabled]="pcLoading">
                    <i *ngIf="pcLoading" class="fas fa-spinner fa-spin me-1"></i>
                    <i *ngIf="!pcLoading" class="fas fa-save me-1"></i>
                    {{ pcLoading ? 'Creating...' : 'Create PC' }}
                </button>
            </div>
        </div>
    </div>
</div> 