<div class="detail-container">
  <div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-title">
          <i [class]="approvalRequest ? getTypeIcon(approvalRequest.type) : 'fas fa-clipboard-check'"></i>
          <div>
            <h1 class="page-title">
              {{ approvalRequest ? getTypeLabel(approvalRequest.type) : 'Approval Request' }}
            </h1>
            <p class="page-subtitle">Request details and actions</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="goBack()">
            <i class="fas fa-arrow-left"></i>
            Back
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading">
      <i class="fas fa-spinner"></i>
      <p>Loading request details...</p>
    </div>

    <!-- Request Details -->
    <div *ngIf="!loading && approvalRequest" class="detail-container-content">
      <div class="detail-grid">
        <!-- Request Information -->
        <div class="detail-section">
          <h3 class="section-title">
            <i class="fas fa-info-circle"></i>
            Request Information
          </h3>
          
          <div class="detail-item">
            <div class="detail-label">Type</div>
            <div class="detail-value">
              <i [class]="getTypeIcon(approvalRequest.type)"></i>
              {{ getTypeLabel(approvalRequest.type) }}
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">
              <span class="request-status" [class]="getStatusClass(approvalRequest.status)">
                {{ approvalRequest.status }}
              </span>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-label">Requested By</div>
            <div class="detail-value">
              {{ approvalRequest.creator?.firstName }} {{ approvalRequest.creator?.lastName }}
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-label">Created</div>
            <div class="detail-value">{{ formatDate(approvalRequest.createdAt!) }}</div>
          </div>

          <div class="detail-item" *ngIf="approvalRequest.approvedBy">
            <div class="detail-label">Processed By</div>
            <div class="detail-value">
              {{ approvalRequest.approver?.firstName }} {{ approvalRequest.approver?.lastName }}
            </div>
          </div>

          <div class="detail-item" *ngIf="approvalRequest.approvedAt">
            <div class="detail-label">Processed</div>
            <div class="detail-value">{{ formatDate(approvalRequest.approvedAt) }}</div>
          </div>
        </div>

        <!-- Request Data -->
        <div class="detail-section">
          <h3 class="section-title">
            <i class="fas fa-database"></i>
            Request Details
          </h3>
          
          <!-- Stock Request Details -->
          <div *ngIf="approvalRequest.type === 'stock'" class="detailed-request-data">
            
            <!-- Bulk Items Section (for multiple items) -->
            <div *ngIf="isBulkRequest()" class="detail-subsection">
              <h4 class="subsection-title">
                <i class="fas fa-boxes"></i>
                Items Information ({{ getRequestData()?.stockEntries?.length }} items)
              </h4>
              
              <div class="bulk-items-table">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Category</th>
                      <th>Brand</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Total</th>
                      <th>Location</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let entry of getEnhancedData()?.enhancedStockEntries">
                      <td>
                        <strong>{{ entry.itemDetails?.name || 'Unknown Item' }}</strong>
                        <br>
                        <small class="text-muted">{{ entry.itemDetails?.model || '' }}</small>
                      </td>
                      <td>{{ entry.itemDetails?.category?.name || 'Unknown Category' }}</td>
                      <td>{{ entry.itemDetails?.brand?.name || 'Unknown Brand' }}</td>
                      <td class="quantity">{{ entry.quantity || 0 }}</td>
                      <td class="price">₱{{ entry.price | number:'1.2-2' }}</td>
                      <td class="total-value">₱{{ entry.totalValue | number:'1.2-2' }}</td>
                      <td>{{ entry.locationDetails?.name || 'Unknown Location' }}</td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="table-success">
                      <th colspan="5">Total Value:</th>
                      <th class="total-value">₱{{ getEnhancedData()?.totalValue | number:'1.2-2' }}</th>
                      <th></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <!-- Single Item Information -->
            <div *ngIf="!isBulkRequest()" class="detail-subsection">
              <h4 class="subsection-title">
                <i class="fas fa-cube"></i>
                Item Information
              </h4>
              
              <div class="detail-row">
                <div class="detail-item">
                  <div class="detail-label">Item Name</div>
                  <div class="detail-value highlight">{{ getItemDisplayName() }}</div>
                </div>
                <div class="detail-item" *ngIf="getEnhancedData()?.itemDetails?.model">
                  <div class="detail-label">Model</div>
                  <div class="detail-value">{{ getEnhancedData()?.itemDetails?.model }}</div>
                </div>
              </div>
              
              <div class="detail-row" *ngIf="getEnhancedData()?.itemDetails?.description">
                <div class="detail-item full-width">
                  <div class="detail-label">Description</div>
                  <div class="detail-value">{{ getEnhancedData()?.itemDetails?.description }}</div>
                </div>
              </div>
              
              <div class="detail-row">
                <div class="detail-item">
                  <div class="detail-label">Category</div>
                  <div class="detail-value">{{ getCategoryDisplayName() }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Brand</div>
                  <div class="detail-value">{{ getBrandDisplayName() }}</div>
                </div>
              </div>
            </div>

            <!-- Stock Information (Single Item Only) -->
            <div *ngIf="!isBulkRequest()" class="detail-subsection">
              <h4 class="subsection-title">
                <i class="fas fa-boxes"></i>
                Stock Information
              </h4>
              
              <div class="detail-row">
                <div class="detail-item">
                  <div class="detail-label">Quantity</div>
                  <div class="detail-value quantity">{{ getDisplayQuantity() }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Unit Price</div>
                  <div class="detail-value price">₱{{ formatCurrency(getDisplayPrice()) }}</div>
                </div>
                <div class="detail-item" *ngIf="getDisplayQuantity() && getDisplayPrice()">
                  <div class="detail-label">Total Value</div>
                  <div class="detail-value total-value">₱{{ formatCurrency(getDisplayQuantity() * getDisplayPrice()) }}</div>
                </div>
              </div>
            </div>

            <!-- Location Information (Single Item Only) -->
            <div *ngIf="!isBulkRequest()" class="detail-subsection">
              <h4 class="subsection-title">
                <i class="fas fa-map-marker-alt"></i>
                Storage Location
              </h4>
              
              <div class="detail-row">
                <div class="detail-item">
                  <div class="detail-label">Location</div>
                  <div class="detail-value highlight">{{ getLocationDisplayName() }}</div>
                </div>
              </div>
              <div class="detail-row" *ngIf="getEnhancedData()?.locationDetails?.description">
                <div class="detail-item full-width">
                  <div class="detail-label">Description</div>
                  <div class="detail-value">{{ getEnhancedData()?.locationDetails?.description }}</div>
                </div>
              </div>
            </div>

            <!-- Additional Information -->
            <div class="detail-subsection" *ngIf="getRequestData()?.remarks || getRequestData()?.receiptAttachment">
              <h4 class="subsection-title">
                <i class="fas fa-info-circle"></i>
                Additional Information
              </h4>
              
              <div class="detail-row" *ngIf="getRequestData()?.remarks">
                <div class="detail-item full-width">
                  <div class="detail-label">Remarks</div>
                  <div class="detail-value">{{ getRequestData()?.remarks }}</div>
                </div>
              </div>
              
              <div class="detail-row" *ngIf="getRequestData()?.receiptAttachment">
                <div class="detail-item full-width">
                  <div class="detail-label">
                    <i class="fas fa-receipt"></i> Receipt Photo
                  </div>
                  <div class="detail-value">
                    <div class="receipt-container">
                      <img 
                        [src]="getReceiptUrl(getRequestData()?.receiptAttachment)" 
                        alt="Receipt Photo" 
                        class="receipt-image"
                        (click)="openReceiptModal(getRequestData()?.receiptAttachment)"
                        style="cursor: pointer; max-width: 200px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                        (error)="onReceiptImageError($event)"
                        (load)="onReceiptImageLoad($event)"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                      >
                      <div class="receipt-placeholder" style="display: none; max-width: 200px; max-height: 150px; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background: #f9f9f9;">
                        <i class="fas fa-receipt" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i>
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Receipt Image<br><small>File: {{ getRequestData()?.receiptAttachment }}</small></p>
                      </div>
                      <div class="receipt-actions mt-2">
                        <button class="btn btn-sm btn-outline-primary" (click)="openReceiptModal(getRequestData()?.receiptAttachment)">
                          <i class="fas fa-expand"></i> View Full Size
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Fallback for dispose or other types -->
          <div *ngIf="approvalRequest.type !== 'stock'" class="request-data">
            {{ formatRequestData(approvalRequest.requestData) }}
          </div>
        </div>
      </div>

      <!-- Rejection Reason -->
      <div *ngIf="approvalRequest.status === 'rejected' && approvalRequest.rejectionReason" class="rejection-reason">
        <h5><i class="fas fa-exclamation-triangle"></i> Rejection Reason</h5>
        <p>{{ approvalRequest.rejectionReason }}</p>
      </div>

      <!-- Remarks -->
      <div *ngIf="approvalRequest.remarks" class="detail-section">
        <h3 class="section-title">
          <i class="fas fa-comment"></i>
          Remarks
        </h3>
        <p>{{ approvalRequest.remarks }}</p>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button 
          *ngIf="canApprove()" 
          class="btn btn-success" 
          (click)="approveRequest()">
          <i class="fas fa-check"></i>
          Approve Request
        </button>
        
        <button 
          *ngIf="canReject()" 
          class="btn btn-danger" 
          (click)="rejectRequest()">
          <i class="fas fa-times"></i>
          Reject Request
        </button>
        
        <button 
          *ngIf="canDelete()" 
          class="btn btn-danger" 
          (click)="deleteRequest()">
          <i class="fas fa-trash"></i>
          Delete Request
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" 
     [class.show]="showReceiptModal"
     [style.display]="showReceiptModal ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-title">
          <i class="fas fa-receipt"></i>
          <div>
            <h1 class="page-title">Receipt Photo</h1>
            <p class="page-subtitle">View receipt attachment</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-close" (click)="closeReceiptModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-body">
      <div class="receipt-viewer">
        <div *ngIf="currentReceiptUrl; else noReceiptTemplate">
          <img 
            [src]="currentReceiptUrl" 
            alt="Receipt Photo" 
            class="receipt-full-image"
            style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);"
            (error)="onReceiptImageError($event)"
            (load)="onReceiptImageLoad($event)"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
          >
          <div class="receipt-error-placeholder" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #ffc107; margin-bottom: 1rem;"></i>
            <h4>Receipt Image Not Found</h4>
            <p class="text-muted">The receipt file "{{ getRequestData()?.receiptAttachment }}" could not be loaded.</p>
            <p class="text-muted"><small>This may be due to the file being moved or deleted from the server.</small></p>
          </div>
        </div>
        <ng-template #noReceiptTemplate>
          <div class="no-receipt-placeholder">
            <i class="fas fa-receipt" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
            <h4>No Receipt Available</h4>
            <p class="text-muted">This stock entry doesn't have a receipt photo attached.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>
